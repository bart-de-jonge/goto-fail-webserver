<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../elements/timeline-picker.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">

<dom-module id="new-user-dialog">
    // Template
    <template>
        <style include="iron-flex"></style>
        <style>
            .horizontal-separator {
                background-color: black;
                height: 1px;
                margin: auto;
                opacity: 0.1;
                width: 100%;
            }

            #newUserInput {
                margin-bottom: 20px;
            }

            #toggles {
                display: flex;
                flex-flow: row wrap;
            }

            paper-toggle-button {
                flex-basis: 50%;
            }
        </style>

        <paper-dialog id="addUserDialog" modal="true">
            <h2>Add a new user</h2>
            <div>


                <paper-tabs on-click="paperTabsClicked" id="newUserTabs" selected="0">
                    <paper-tab>Camera operator</paper-tab>
                    <paper-tab>Shotcaller</paper-tab>
                    <paper-tab>Director</paper-tab>
                </paper-tabs>

                <paper-input on-input="nameInputChanged" error-message="Username required" label="User name:" id="newUserInput"></paper-input>

                <div class="horizontal-separator"></div>

                <div class="card-content">
                    <div class="content-header" style="margin-bottom: 10px;"> Active camera timelines</div>
                    <div id="toggles" class="layout horizontal flex">
                        <template is="dom-repeat" items="{{timelines}}">
                            <paper-toggle-button value="{{index}}" class="newUserToggleButton">{{item.name}}</paper-toggle-button>
                        </template>
                    </div>
                </div>

            </div>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button id="addUserConfirmButton" on-tap="addUserConfirmButtonTapped">Add user</paper-button>
            </div>
        </paper-dialog>
    </template>
    <script>
        class newUserDialog {
            beforeRegister() {
                this.is = "new-user-dialog";

                this.properties = {
                    timelines: Array,
                };
            }

            addUserConfirmButtonTapped() {
                if (this.$.newUserInput.value.length === 0) {
                    this.$.newUserInput.invalid = true;
                } else {
                    const users = document.querySelector("gotofail-login").users;
                    const id = users[users.length - 1].id + 1;
                    const pickedTimelines = [];
                    const name = this.$.newUserInput.value;
                    const jobType = Number(this.$.newUserTabs.selected);

                    Array.from(document.querySelectorAll("paper-toggle-button.newUserToggleButton[checked]")).forEach(function(user) {
                       pickedTimelines.push(user.value);
                    });

                    const newUser = {id: id,
                                    name: name,
                                    pickedTimelines: pickedTimelines,
                                    jobType: jobType};
                    document.querySelector("gotofail-login").addUser(newUser);
                    this.$.addUserDialog.close();
                }
            }

            open() {
                this.$.addUserDialog.open();
            }

            nameInputChanged(e) {
                if (e.target.value.length === 0) {
                    this.$.newUserInput.invalid = true;
                } else {
                    this.$.newUserInput.invalid = false;
                }
            }

            paperTabsClicked(e) {
                const toggles = Array.from(document.querySelectorAll("paper-toggle-button.newUserToggleButton"));
                if (this.$.newUserTabs.selected === 0) {
                    // Camera operator
                    toggles.forEach(function(toggle) {
                        toggle.disabled = false;
                    })
                } else {
                    toggles.forEach(function(toggle) {
                        toggle.disabled = true;
                        toggle.checked = false;
                    });
                }
            }
        }
        // eslint-disable-next-line
        Polymer(newUserDialog);
    </script>

</dom-module>