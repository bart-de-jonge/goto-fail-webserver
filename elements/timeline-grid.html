<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="timeline-element.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<dom-module id="timeline-grid">
    // Template
    <template>
        <style include="iron-flex"></style>
        <style>
            timeline-element:nth-of-type(n+2) {
                margin-left: 20px;
            }
        </style>
        <iron-ajax
                auto
                url="/timeline/timeline-data"
                handle-as="json"
                on-response="handleResponse"
                id="ajax-timeline-data"></iron-ajax>

        <div class="layout horizontal">
            <template is="dom-repeat" items="{{timeline_data.cameraTimelines}}">
                <timeline-element timeline_data="{{item}}" class="flex"></timeline-element>
            </template>
        </div>

    </template>

    // Scripts
    <script>
    (function() {
    'use strict';
    class timelineGrid {
        beforeRegister() {
            this.is = 'timeline-grid';

            this.properties = {
                name: String,
                timeline_data: Object
            };
        }
        handleResponse(event) {
            // Setup lists for timelines
            // TODO: find a way to correctly execute this in timeline-element

            // Get data from ajax response
            let response_data = event.detail.response;
            console.log(response_data);

            // Get the maxCount of the entire grid
            var maxCount = 0;
            response_data.cameraTimelines.forEach(function (timeline) {
                if(timeline.cameraShots.length > 0) {
                    console.log("here");
                    var curEndCount = parseFloat(timeline.cameraShots[timeline.cameraShots.length - 1].endCount);
                    if (curEndCount > maxCount) {
                        maxCount = curEndCount;
                    }
                }

                // Set visible property of existing blocks
                timeline.cameraShots.forEach(function(shot) {
                    shot.visible = "visible";
                });
            });

            console.log(maxCount);

            // Setup new data
            var new_data = {};
            new_data.minCount = 0;
            new_data.maxCount = maxCount;
            new_data.cameraTimelines = [];


            // Loop over all counts and pad with non-visible blocks where necessary
            response_data.cameraTimelines.forEach(function (timeline, index) {
                // Setup timeline
                var new_timeline = {};
                new_timeline.name = timeline.name;
                new_timeline.description = timeline.description;
                new_timeline.cameraShots = [];
                new_data.cameraTimelines[index] = new_timeline;

                // Only do following if at least one block is present
                if(timeline.cameraShots.length > 0) {
                    // Add padding before the first block
                    if (timeline.cameraShots[0].beginCount != 0) {
                        var newShot = {
                            beginCount: "0",
                            endCount: timeline.cameraShots[0].beginCount,
                            visible: "hidden"
                        };
                        new_timeline.cameraShots.push(newShot);
                    }

                    // Add padding after each consecutive block:
                    timeline.cameraShots.forEach(function (shot, i) {
                        new_timeline.cameraShots.push(shot);
                        if (i < timeline.cameraShots.length - 1) {
                            // Not the last block
                            var endCount = (timeline.cameraShots[i + 1].beginCount * 4 ) / 4;
                            var newShot = {
                                beginCount: shot.endCount,
                                endCount: endCount,
                                visible: "hidden"
                            };
                            new_timeline.cameraShots.push(newShot);
                        } else {
                            // The last block
                            if (parseFloat(shot.endCount) != maxCount) {
                                // There is room leeft in timeline
                                var newShot = {
                                    beginCount: shot.endCount,
                                    endCount: maxCount,
                                    visible: "hidden"
                                };
                                new_timeline.cameraShots.push(newShot);
                            }
                        }
                    });
                } else {
                    // Add one block to fill the timeline
                    var newShot = {
                        beginCount: 0,
                        endCount: maxCount,
                        visible: "hidden"
                    };
                    new_timeline.cameraShots.push(newShot);
                }

                // Set length of blocks
                new_timeline.cameraShots.forEach(function (shot) {
                    // 4 = number of blocks per count, 10 is height per block
                    shot.pixelLength = (shot.endCount - shot.beginCount) * 4 * 10;
                });
            });

            // Set data to property
            this.timeline_data = new_data;
        }
    }
    Polymer(timelineGrid);
    })();
    </script>
</dom-module>